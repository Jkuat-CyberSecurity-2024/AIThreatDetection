{% extends "dashboard/base_dashboard.html" %}
{% block content %}
<style>
    .visualization-section {
        padding: 0;
        background-color: #ffffff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }

    .visualization-header {
        background-color: #2e7d32;
        padding: 20px;
        margin-bottom: 20px;
    }

    .visualization-header h1 {
        color: #ffffff;
        margin: 0;
        font-size: 24px;
    }

    .visualization-content {
        padding: 0 20px 20px;
    }

    .chart-container {
        background-color: #f1f8e9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: bold;
        color: #2e7d32;
        margin-bottom: 10px;
    }

    .chart {
        width: 100%;
        height: 300px;
    }

    .metrics-summary {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .metric-card {
        background-color: #e8f5e9;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        margin: 0 10px;
        text-align: center;
    }

    .metric-card h3 {
        color: #2e7d32;
        margin-bottom: 10px;
    }

    .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #1b5e20;
    }

    @media (max-width: 768px) {
        .metrics-summary {
            flex-direction: column;
        }

        .metric-card {
            margin: 10px 0;
        }
    }
</style>

<div id="visualization" class="visualization-section">
    <div class="visualization-header">
        <h1>Metrics Visualization</h1>
    </div>

    <div class="visualization-content">
        <div class="metrics-summary">
            <div class="metric-card">
                <h3>Total Live Requests</h3>
                <div id="totalRequests" class="metric-value">0</div>
            </div>
            <div class="metric-card">
                <h3>Total Anomalies Detected</h3>
                <div id="totalAnomalies" class="metric-value">0</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Request Types Distribution</div>
            <div id="requestTypesChart" class="chart"></div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Request Logs Over Time</div>
            <div id="requestLogsChart" class="chart"></div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Anomalies Trend</div>
            <div id="anomaliesTrendChart" class="chart"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    function generateMockData() {
        const now = new Date();
        const data = {
            totalRequests: Math.floor(Math.random() * 10000) + 5000,
            totalAnomalies: Math.floor(Math.random() * 500) + 100,
            requestTypes: {
                GET: Math.floor(Math.random() * 5000) + 2000,
                POST: Math.floor(Math.random() * 3000) + 1000,
                PUT: Math.floor(Math.random() * 1000) + 500,
                DELETE: Math.floor(Math.random() * 500) + 100
            },
            requestLogs: {
                GET: [],
                POST: [],
                PUT: [],
                DELETE: []
            },
            anomaliesTrend: []
        };

        for (let i = 0; i < 24; i++) {
            const time = new Date(now.getTime() - (23 - i) * 60 * 60 * 1000);
            data.requestLogs.GET.push({
                x: time.toISOString(),
                y: Math.floor(Math.random() * 500) + 50
            });
            data.requestLogs.POST.push({
                x: time.toISOString(),
                y: Math.floor(Math.random() * 300) + 30
            });
            data.requestLogs.PUT.push({
                x: time.toISOString(),
                y: Math.floor(Math.random() * 100) + 10
            });
            data.requestLogs.DELETE.push({
                x: time.toISOString(),
                y: Math.floor(Math.random() * 50) + 5
            });
            data.anomaliesTrend.push({
                x: time.toISOString(),
                y: Math.floor(Math.random() * 50) + 10
            });
        }

        return data;
    }

    function updateCharts() {
        const data = generateMockData();

        document.getElementById('totalRequests').textContent = data.totalRequests.toLocaleString();
        document.getElementById('totalAnomalies').textContent = data.totalAnomalies.toLocaleString();

        new ApexCharts(document.querySelector("#requestTypesChart"), {
            series: Object.values(data.requestTypes),
            labels: Object.keys(data.requestTypes),
            chart: {
                type: 'donut',
                height: 300
            },
            colors: ['#4caf50', '#8bc34a', '#cddc39', '#ffeb3b'],
            legend: {
                position: 'bottom'
            }
        }).render();

        new ApexCharts(document.querySelector("#requestLogsChart"), {
            series: [
                {
                    name: 'GET',
                    data: data.requestLogs.GET
                },
                {
                    name: 'POST',
                    data: data.requestLogs.POST
                },
                {
                    name: 'PUT',
                    data: data.requestLogs.PUT
                },
                {
                    name: 'DELETE',
                    data: data.requestLogs.DELETE
                }
            ],
            chart: {
                type: 'line',
                height: 300,
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            xaxis: {
                type: 'datetime'
            },
            yaxis: {
                title: {
                    text: 'Number of Requests'
                }
            },
            colors: ['#4caf50', '#8bc34a', '#cddc39', '#ffeb3b'],
            legend: {
                position: 'top'
            }
        }).render();

        new ApexCharts(document.querySelector("#anomaliesTrendChart"), {
            series: [{
                name: 'Anomalies',
                data: data.anomaliesTrend
            }],
            chart: {
                type: 'line',
                height: 300,
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight'
            },
            xaxis: {
                type: 'datetime'
            },
            yaxis: {
                title: {
                    text: 'Number of Anomalies'
                }
            },
            colors: ['#f44336']
        }).render();
    }

    updateCharts();
    setInterval(updateCharts, 5 * 60 * 1000);
</script>
{% endblock %}